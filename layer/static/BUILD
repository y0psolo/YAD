load("@bazel_tools//tools/build_defs/pkg:pkg.bzl", "pkg_tar")
load("@io_bazel_rules_docker//container:container.bzl", "container_layer")
load("@io_bazel_rules_docker//contrib:group.bzl", "group_entry", "group_file")
load("@io_bazel_rules_docker//contrib:passwd.bzl", "passwd_entry", "passwd_tar")
load("//util:constants.bzl", "NOBODY", "NONROOT")
load("//util:osrelease.bzl", "gen_osrelease")
load("//platforms:cpu.bzl", "ubuntu_debs")

# load_settings()

# Create /etc/passwd with the root user
passwd_entry(
    name = "root_user",
    gid = 0,
    home = "/root",
    info = "root",
    shell = "/sbin/nologin",
    uid = 0,
    username = "root",
)

passwd_entry(
    name = "nobody_user",
    create_home = False,
    gid = NOBODY,
    home = "/nonexistent",
    info = "nobody",
    shell = "/sbin/nologin",
    uid = NOBODY,
    username = "nobody",
)

passwd_entry(
    name = "nonroot_user",
    gid = NONROOT,
    home = "/home/nonroot",
    info = "nonroot",
    shell = "/sbin/nologin",
    uid = NONROOT,
    username = "nonroot",
)

passwd_tar(
    name = "passwd",
    entries = [
        ":root_user",
        ":nobody_user",
        ":nonroot_user",
    ],
    passwd_file_pkg_dir = "etc",
    visibility = ["//:__subpackages__"],
)

# Create /etc/group with the root, tty, and staff groups
group_entry(
    name = "root_group",
    gid = 0,
    groupname = "root",
)

group_entry(
    name = "nobody_group",
    gid = NOBODY,
    groupname = "nobody",
)

group_entry(
    name = "nonroot_group",
    gid = NONROOT,
    groupname = "nonroot",
)

group_entry(
    name = "tty_group",
    gid = 5,
    groupname = "tty",
)

group_entry(
    name = "staff_group",
    gid = 50,
    groupname = "staff",
)

group_file(
    name = "group",
    entries = [
        ":root_group",
        ":nobody_group",
        ":tty_group",
        ":staff_group",
        ":nonroot_group",
    ],
)

pkg_tar(
    name = "group_tar",
    srcs = [":group"],
    mode = "0644",
    package_dir = "etc",
    visibility = ["//:__subpackages__"],
)

# Os release file
gen_osrelease(
    name = "ubuntu_osrelease",
    distribution = "Ubuntu",
    distribution_like = "debian",
    release = "Focal Fossa",
    version = "20.04.3 LTS",
)

pkg_tar(
    name = "os_release_tar",
    srcs = [":ubuntu_osrelease"],
    mode = "0644",
    package_dir = "/etc",
)

# Busybox

alias(
    name = "busybox",
    actual = select ({
        "//platforms:k8_cpu": "@busybox_amd64//file",
        "//platforms:aarch64_cpu": "@busybox_arm64//file",
    })
)

pkg_tar(
    name = "busybox_tar",
    srcs = [":busybox"],
    mode = "0555",
    package_dir = "/bin",
)

container_layer(
    name = "static",
    debs = ubuntu_debs([
        "base-files",
        "netbase",
        "tzdata"
    ]),
    empty_dirs = ["/home"],
    env = {
        "PATH": "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
        # allows openssl to find the certificates by default
        # TODO: We should run update-ca-certifaces, but that requires "openssl rehash"
        # which would probably need to be run inside the container
        "SSL_CERT_FILE": "/etc/ssl/certs/ca-certificates.crt",
    },
    tars = [
        ":passwd",
        ":group_tar",
        # Create /tmp, too many things assume it exists.
        # tmp.tar has a /tmp with the correct permissions 01777
        # A tar is needed because at the moment there is no way to create a
        # directory with specific permissions.
        ":tmp.tar",
        ":nsswitch.tar",
        ":os_release_tar",
        "//util:cacerts.tar",
    ],
    visibility = ["//visibility:public"],
)


container_layer(
    name = "debug",
    symlinks = {
        "/bin/[": "/bin/busybox",
        "/bin/[[": "/bin/busybox",
        "/bin/acpid": "/bin/busybox",
        "/bin/add-shell": "/bin/busybox",
        "/bin/addgroup": "/bin/busybox",
        "/bin/adduser": "/bin/busybox",
        "/bin/adjtimex": "/bin/busybox",
        "/bin/ar": "/bin/busybox",
        "/bin/arp": "/bin/busybox",
        "/bin/arping": "/bin/busybox",
        "/bin/ash": "/bin/busybox",
        "/bin/awk": "/bin/busybox",
        "/bin/base64": "/bin/busybox",
        "/bin/basename": "/bin/busybox",
        "/bin/blkdiscard": "/bin/busybox",
        "/bin/blkid": "/bin/busybox",
        "/bin/blockdev": "/bin/busybox",
        "/bin/bootchartd": "/bin/busybox",
        "/bin/brctl": "/bin/busybox",
        "/bin/bunzip2": "/bin/busybox",
        "/bin/bzcat": "/bin/busybox",
        "/bin/bzip2": "/bin/busybox",
        "/bin/cal": "/bin/busybox",
        "/bin/cat": "/bin/busybox",
        "/bin/chat": "/bin/busybox",
        "/bin/chattr": "/bin/busybox",
        "/bin/chgrp": "/bin/busybox",
        "/bin/chmod": "/bin/busybox",
        "/bin/chown": "/bin/busybox",
        "/bin/chpasswd": "/bin/busybox",
        "/bin/chpst": "/bin/busybox",
        "/bin/chroot": "/bin/busybox",
        "/bin/chrt": "/bin/busybox",
        "/bin/chvt": "/bin/busybox",
        "/bin/cksum": "/bin/busybox",
        "/bin/clear": "/bin/busybox",
        "/bin/cmp": "/bin/busybox",
        "/bin/comm": "/bin/busybox",
        "/bin/conspy": "/bin/busybox",
        "/bin/cp": "/bin/busybox",
        "/bin/cpio": "/bin/busybox",
        "/bin/crond": "/bin/busybox",
        "/bin/crontab": "/bin/busybox",
        "/bin/cryptpw": "/bin/busybox",
        "/bin/cttyhack": "/bin/busybox",
        "/bin/cut": "/bin/busybox",
        "/bin/date": "/bin/busybox",
        "/bin/dc": "/bin/busybox",
        "/bin/dd": "/bin/busybox",
        "/bin/deallocvt": "/bin/busybox",
        "/bin/delgroup": "/bin/busybox",
        "/bin/deluser": "/bin/busybox",
        "/bin/depmod": "/bin/busybox",
        "/bin/devmem": "/bin/busybox",
        "/bin/df": "/bin/busybox",
        "/bin/dhcprelay": "/bin/busybox",
        "/bin/diff": "/bin/busybox",
        "/bin/dirname": "/bin/busybox",
        "/bin/dmesg": "/bin/busybox",
        "/bin/dnsd": "/bin/busybox",
        "/bin/dnsdomainname": "/bin/busybox",
        "/bin/dos2unix": "/bin/busybox",
        "/bin/dpkg": "/bin/busybox",
        "/bin/dpkg-deb": "/bin/busybox",
        "/bin/du": "/bin/busybox",
        "/bin/dumpkmap": "/bin/busybox",
        "/bin/dumpleases": "/bin/busybox",
        "/bin/echo": "/bin/busybox",
        "/bin/ed": "/bin/busybox",
        "/bin/egrep": "/bin/busybox",
        "/bin/eject": "/bin/busybox",
        "/bin/env": "/bin/busybox",
        "/bin/envdir": "/bin/busybox",
        "/bin/envuidgid": "/bin/busybox",
        "/bin/expand": "/bin/busybox",
        "/bin/expr": "/bin/busybox",
        "/bin/factor": "/bin/busybox",
        "/bin/fakeidentd": "/bin/busybox",
        "/bin/false": "/bin/busybox",
        "/bin/fatattr": "/bin/busybox",
        "/bin/fbset": "/bin/busybox",
        "/bin/fbsplash": "/bin/busybox",
        "/bin/fdflush": "/bin/busybox",
        "/bin/fdformat": "/bin/busybox",
        "/bin/fdisk": "/bin/busybox",
        "/bin/fgconsole": "/bin/busybox",
        "/bin/fgrep": "/bin/busybox",
        "/bin/find": "/bin/busybox",
        "/bin/findfs": "/bin/busybox",
        "/bin/flash_eraseall": "/bin/busybox",
        "/bin/flash_lock": "/bin/busybox",
        "/bin/flash_unlock": "/bin/busybox",
        "/bin/flashcp": "/bin/busybox",
        "/bin/flock": "/bin/busybox",
        "/bin/fold": "/bin/busybox",
        "/bin/free": "/bin/busybox",
        "/bin/freeramdisk": "/bin/busybox",
        "/bin/fsck": "/bin/busybox",
        "/bin/fsck.minix": "/bin/busybox",
        "/bin/fsfreeze": "/bin/busybox",
        "/bin/fstrim": "/bin/busybox",
        "/bin/fsync": "/bin/busybox",
        "/bin/ftpd": "/bin/busybox",
        "/bin/ftpget": "/bin/busybox",
        "/bin/ftpput": "/bin/busybox",
        "/bin/fuser": "/bin/busybox",
        "/bin/getopt": "/bin/busybox",
        "/bin/getty": "/bin/busybox",
        "/bin/grep": "/bin/busybox",
        "/bin/groups": "/bin/busybox",
        "/bin/gunzip": "/bin/busybox",
        "/bin/gzip": "/bin/busybox",
        "/bin/halt": "/bin/busybox",
        "/bin/hd": "/bin/busybox",
        "/bin/hdparm": "/bin/busybox",
        "/bin/head": "/bin/busybox",
        "/bin/hexdump": "/bin/busybox",
        "/bin/hostid": "/bin/busybox",
        "/bin/hostname": "/bin/busybox",
        "/bin/httpd": "/bin/busybox",
        "/bin/hush": "/bin/busybox",
        "/bin/hwclock": "/bin/busybox",
        "/bin/i2cdetect": "/bin/busybox",
        "/bin/i2cdump": "/bin/busybox",
        "/bin/i2cget": "/bin/busybox",
        "/bin/i2cset": "/bin/busybox",
        "/bin/id": "/bin/busybox",
        "/bin/ifconfig": "/bin/busybox",
        "/bin/ifenslave": "/bin/busybox",
        "/bin/ifplugd": "/bin/busybox",
        "/bin/inetd": "/bin/busybox",
        "/bin/init": "/bin/busybox",
        "/bin/inotifyd": "/bin/busybox",
        "/bin/insmod": "/bin/busybox",
        "/bin/install": "/bin/busybox",
        "/bin/ionice": "/bin/busybox",
        "/bin/iostat": "/bin/busybox",
        "/bin/ip": "/bin/busybox",
        "/bin/ipaddr": "/bin/busybox",
        "/bin/ipcalc": "/bin/busybox",
        "/bin/ipcrm": "/bin/busybox",
        "/bin/ipcs": "/bin/busybox",
        "/bin/iplink": "/bin/busybox",
        "/bin/ipneigh": "/bin/busybox",
        "/bin/iproute": "/bin/busybox",
        "/bin/iprule": "/bin/busybox",
        "/bin/iptunnel": "/bin/busybox",
        "/bin/kbd_mode": "/bin/busybox",
        "/bin/kill": "/bin/busybox",
        "/bin/killall": "/bin/busybox",
        "/bin/killall5": "/bin/busybox",
        "/bin/klogd": "/bin/busybox",
        "/bin/last": "/bin/busybox",
        "/bin/less": "/bin/busybox",
        "/bin/link": "/bin/busybox",
        "/bin/linux32": "/bin/busybox",
        "/bin/linux64": "/bin/busybox",
        "/bin/linuxrc": "/bin/busybox",
        "/bin/ln": "/bin/busybox",
        "/bin/loadfont": "/bin/busybox",
        "/bin/loadkmap": "/bin/busybox",
        "/bin/logger": "/bin/busybox",
        "/bin/login": "/bin/busybox",
        "/bin/logname": "/bin/busybox",
        "/bin/losetup": "/bin/busybox",
        "/bin/lpd": "/bin/busybox",
        "/bin/lpq": "/bin/busybox",
        "/bin/lpr": "/bin/busybox",
        "/bin/ls": "/bin/busybox",
        "/bin/lsattr": "/bin/busybox",
        "/bin/lsmod": "/bin/busybox",
        "/bin/lsof": "/bin/busybox",
        "/bin/lspci": "/bin/busybox",
        "/bin/lsscsi": "/bin/busybox",
        "/bin/lsusb": "/bin/busybox",
        "/bin/lzcat": "/bin/busybox",
        "/bin/lzma": "/bin/busybox",
        "/bin/lzop": "/bin/busybox",
        "/bin/lzopcat": "/bin/busybox",
        "/bin/makedevs": "/bin/busybox",
        "/bin/makemime": "/bin/busybox",
        "/bin/man": "/bin/busybox",
        "/bin/md5sum": "/bin/busybox",
        "/bin/mdev": "/bin/busybox",
        "/bin/mesg": "/bin/busybox",
        "/bin/microcom": "/bin/busybox",
        "/bin/mkdir": "/bin/busybox",
        "/bin/mkdosfs": "/bin/busybox",
        "/bin/mke2fs": "/bin/busybox",
        "/bin/mkfifo": "/bin/busybox",
        "/bin/mkfs.ext2": "/bin/busybox",
        "/bin/mkfs.minix": "/bin/busybox",
        "/bin/mkfs.vfat": "/bin/busybox",
        "/bin/mknod": "/bin/busybox",
        "/bin/mkpasswd": "/bin/busybox",
        "/bin/mkswap": "/bin/busybox",
        "/bin/mktemp": "/bin/busybox",
        "/bin/modinfo": "/bin/busybox",
        "/bin/modprobe": "/bin/busybox",
        "/bin/more": "/bin/busybox",
        "/bin/mount": "/bin/busybox",
        "/bin/mountpoint": "/bin/busybox",
        "/bin/mpstat": "/bin/busybox",
        "/bin/mt": "/bin/busybox",
        "/bin/mv": "/bin/busybox",
        "/bin/nameif": "/bin/busybox",
        "/bin/nbd-client": "/bin/busybox",
        "/bin/nc": "/bin/busybox",
        "/bin/netstat": "/bin/busybox",
        "/bin/nice": "/bin/busybox",
        "/bin/nl": "/bin/busybox",
        "/bin/nmeter": "/bin/busybox",
        "/bin/nohup": "/bin/busybox",
        "/bin/nproc": "/bin/busybox",
        "/bin/ntpd": "/bin/busybox",
        "/bin/od": "/bin/busybox",
        "/bin/openvt": "/bin/busybox",
        "/bin/partprobe": "/bin/busybox",
        "/bin/passwd": "/bin/busybox",
        "/bin/paste": "/bin/busybox",
        "/bin/patch": "/bin/busybox",
        "/bin/pgrep": "/bin/busybox",
        "/bin/pidof": "/bin/busybox",
        "/bin/ping": "/bin/busybox",
        "/bin/ping6": "/bin/busybox",
        "/bin/pipe_progress": "/bin/busybox",
        "/bin/pivot_root": "/bin/busybox",
        "/bin/pkill": "/bin/busybox",
        "/bin/pmap": "/bin/busybox",
        "/bin/popmaildir": "/bin/busybox",
        "/bin/poweroff": "/bin/busybox",
        "/bin/powertop": "/bin/busybox",
        "/bin/printenv": "/bin/busybox",
        "/bin/printf": "/bin/busybox",
        "/bin/ps": "/bin/busybox",
        "/bin/pscan": "/bin/busybox",
        "/bin/pstree": "/bin/busybox",
        "/bin/pwd": "/bin/busybox",
        "/bin/pwdx": "/bin/busybox",
        "/bin/raidautorun": "/bin/busybox",
        "/bin/rdate": "/bin/busybox",
        "/bin/rdev": "/bin/busybox",
        "/bin/readlink": "/bin/busybox",
        "/bin/readprofile": "/bin/busybox",
        "/bin/realpath": "/bin/busybox",
        "/bin/reboot": "/bin/busybox",
        "/bin/reformime": "/bin/busybox",
        "/bin/remove-shell": "/bin/busybox",
        "/bin/renice": "/bin/busybox",
        "/bin/reset": "/bin/busybox",
        "/bin/resize": "/bin/busybox",
        "/bin/rev": "/bin/busybox",
        "/bin/rm": "/bin/busybox",
        "/bin/rmdir": "/bin/busybox",
        "/bin/rmmod": "/bin/busybox",
        "/bin/route": "/bin/busybox",
        "/bin/rpm": "/bin/busybox",
        "/bin/rpm2cpio": "/bin/busybox",
        "/bin/rtcwake": "/bin/busybox",
        "/bin/run-parts": "/bin/busybox",
        "/bin/runlevel": "/bin/busybox",
        "/bin/runsv": "/bin/busybox",
        "/bin/runsvdir": "/bin/busybox",
        "/bin/rx": "/bin/busybox",
        "/bin/script": "/bin/busybox",
        "/bin/scriptreplay": "/bin/busybox",
        "/bin/sed": "/bin/busybox",
        "/bin/sendmail": "/bin/busybox",
        "/bin/seq": "/bin/busybox",
        "/bin/setarch": "/bin/busybox",
        "/bin/setconsole": "/bin/busybox",
        "/bin/setfont": "/bin/busybox",
        "/bin/setkeycodes": "/bin/busybox",
        "/bin/setlogcons": "/bin/busybox",
        "/bin/setpriv": "/bin/busybox",
        "/bin/setserial": "/bin/busybox",
        "/bin/setsid": "/bin/busybox",
        "/bin/setuidgid": "/bin/busybox",
        "/bin/sh": "/bin/busybox",
        "/bin/sha1sum": "/bin/busybox",
        "/bin/sha256sum": "/bin/busybox",
        "/bin/sha3sum": "/bin/busybox",
        "/bin/sha512sum": "/bin/busybox",
        "/bin/showkey": "/bin/busybox",
        "/bin/shred": "/bin/busybox",
        "/bin/shuf": "/bin/busybox",
        "/bin/slattach": "/bin/busybox",
        "/bin/sleep": "/bin/busybox",
        "/bin/smemcap": "/bin/busybox",
        "/bin/softlimit": "/bin/busybox",
        "/bin/sort": "/bin/busybox",
        "/bin/split": "/bin/busybox",
        "/bin/ssl_client": "/bin/busybox",
        "/bin/start-stop-daemon": "/bin/busybox",
        "/bin/stat": "/bin/busybox",
        "/bin/strings": "/bin/busybox",
        "/bin/stty": "/bin/busybox",
        "/bin/su": "/bin/busybox",
        "/bin/sulogin": "/bin/busybox",
        "/bin/sum": "/bin/busybox",
        "/bin/sv": "/bin/busybox",
        "/bin/svc": "/bin/busybox",
        "/bin/svlogd": "/bin/busybox",
        "/bin/swapoff": "/bin/busybox",
        "/bin/swapon": "/bin/busybox",
        "/bin/switch_root": "/bin/busybox",
        "/bin/sync": "/bin/busybox",
        "/bin/sysctl": "/bin/busybox",
        "/bin/syslogd": "/bin/busybox",
        "/bin/tac": "/bin/busybox",
        "/bin/tail": "/bin/busybox",
        "/bin/tar": "/bin/busybox",
        "/bin/taskset": "/bin/busybox",
        "/bin/tcpsvd": "/bin/busybox",
        "/bin/tee": "/bin/busybox",
        "/bin/telnet": "/bin/busybox",
        "/bin/telnetd": "/bin/busybox",
        "/bin/test": "/bin/busybox",
        "/bin/tftp": "/bin/busybox",
        "/bin/tftpd": "/bin/busybox",
        "/bin/time": "/bin/busybox",
        "/bin/timeout": "/bin/busybox",
        "/bin/top": "/bin/busybox",
        "/bin/touch": "/bin/busybox",
        "/bin/tr": "/bin/busybox",
        "/bin/traceroute": "/bin/busybox",
        "/bin/traceroute6": "/bin/busybox",
        "/bin/true": "/bin/busybox",
        "/bin/truncate": "/bin/busybox",
        "/bin/tty": "/bin/busybox",
        "/bin/ttysize": "/bin/busybox",
        "/bin/tunctl": "/bin/busybox",
        "/bin/tune2fs": "/bin/busybox",
        "/bin/ubiattach": "/bin/busybox",
        "/bin/ubidetach": "/bin/busybox",
        "/bin/ubimkvol": "/bin/busybox",
        "/bin/ubirename": "/bin/busybox",
        "/bin/ubirmvol": "/bin/busybox",
        "/bin/ubirsvol": "/bin/busybox",
        "/bin/ubiupdatevol": "/bin/busybox",
        "/bin/udhcpc": "/bin/busybox",
        "/bin/udhcpd": "/bin/busybox",
        "/bin/udpsvd": "/bin/busybox",
        "/bin/uevent": "/bin/busybox",
        "/bin/umount": "/bin/busybox",
        "/bin/uname": "/bin/busybox",
        "/bin/uncompress": "/bin/busybox",
        "/bin/unexpand": "/bin/busybox",
        "/bin/uniq": "/bin/busybox",
        "/bin/unix2dos": "/bin/busybox",
        "/bin/unlink": "/bin/busybox",
        "/bin/unlzma": "/bin/busybox",
        "/bin/unlzop": "/bin/busybox",
        "/bin/unxz": "/bin/busybox",
        "/bin/unzip": "/bin/busybox",
        "/bin/uptime": "/bin/busybox",
        "/bin/users": "/bin/busybox",
        "/bin/usleep": "/bin/busybox",
        "/bin/uudecode": "/bin/busybox",
        "/bin/uuencode": "/bin/busybox",
        "/bin/vconfig": "/bin/busybox",
        "/bin/vi": "/bin/busybox",
        "/bin/vlock": "/bin/busybox",
        "/bin/volname": "/bin/busybox",
        "/bin/w": "/bin/busybox",
        "/bin/wall": "/bin/busybox",
        "/bin/watch": "/bin/busybox",
        "/bin/watchdog": "/bin/busybox",
        "/bin/wc": "/bin/busybox",
        "/bin/wget": "/bin/busybox",
        "/bin/which": "/bin/busybox",
        "/bin/who": "/bin/busybox",
        "/bin/whoami": "/bin/busybox",
        "/bin/whois": "/bin/busybox",
        "/bin/xargs": "/bin/busybox",
        "/bin/xxd": "/bin/busybox",
        "/bin/xz": "/bin/busybox",
        "/bin/xzcat": "/bin/busybox",
        "/bin/yes": "/bin/busybox",
        "/bin/zcat": "/bin/busybox",
        "/bin/zcip": "/bin/busybox",
    },
    tars = [
        ":busybox_tar",
    ],
    visibility = ["//visibility:public"],
)
